# hw_ccb_v5
===============================================================================================
			    STM32F429BI(208pin) 기반 CCB 프로젝트 
===============================================================================================
  버전 			날짜 			구분					내용 
===============================================================================================
V0.0.0.35	2021.11.01		DOR		추가		원격 호퍼 잠금/해제 기능 구현(CCB2)
------------------------------------------------------------------------------
V0.0.0.34	2021.10.12		LED		개선 	적재 높이 표시 거리에서 백분율로 변경  
                    		FLS		수정 	전원 제어시 채널 초기화 함수 제거
											(정기센싱 웨이크업 후 시스템 무한루프 되는 문제처리)
							COM		추가 	마지막 통신 이후 24시간 경과시 생존 통신 시작
-----------------------------------------------------------------------------------------------
V0.0.0.33	2021.09.29		SYS		OTA 다운로드 중에 버퍼 full일 때 버퍼 스위치 안되는 문제 처리
-----------------------------------------------------------------------------------------------
V0.0.0.32	2021.09.14		SYS		SDRAM 코드 삭제 (소비전류 최소화)
									슬립 진입 전 하트 비트 LED 끄기
									원점 검사 함수 호출 후 원점 전원 끄기
									(기존 전원을 끄지 않아서 계속 전류 소비 발생)
									전면문 닫힘 후 모터 동작을 원점으로 검사를 모터 상태 변수 검사로 변경 
									(원점 검사 함수를 통한 원점에 전원을 넣는 방식 회피 목적)
									배터리 모드 (노멀/스탠바이/슬립/셧다운) 동작 추가
									SYS_CheckCRC에서 EE_Format()함수 제거
									(함수에서 페이지1를 지우지 않는 버그 존재)
									배터리모드별 동작 처리
									통신주기/센싱주기 응답 수신 후 다음 통신에 확인 전송
							LED		내부클럭 사용 활성화를 통한 스탠바이모드에서 동작 가능
							MOT		하강보다 상승이 엔코더 갯수가 100개 더 많이 지정
									(시간도 1초 정도 더 걸림)									 		
------------------------------------------------------------------------------
V0.0.0.31	2021.08.04		MOT		상승 엔코더 로그 저장은 압축 후 처리
									화재 압축일 때 전류 초과 로그 저장하지 않는 부분 해제
									하강 엔코더 초과분 상승 엔코더에 오프셋으로 합산 처리
									모터 상승 조건일 때만 모터 엔코더 인터럽트 증가 처리
									(다른 상태에서 엔코더 간헐적 증가되는 문제 처리)
									압축 전 원점 감지일 때는 상승 엔코더 카운터 무시 처리
									원점 검출 조건에 1초 딜레이 추가 부분 제거
									(상승에서 즉시 감지처리되고, 하강일 때는 정지 조건에서 제외되어 있어서 딜레이 불필요)
									모터 구동 피크 전류 획득 속도 개선을 위한 ADC 100ms->50ms 단축 처리
									모터 동작 종료시 원점 아니면 led 처리 부분 제거
									(모터 동작 완료 후 적재량 상태 표시 상태로 전환)
									모터 ON state 대기시간 1초->0.5초 처리
									(상승엔코더 정지에 의한 원점복귀후하강에서 전류초과로 정지 무관)
------------------------------------------------------------------------------
V0.0.0.30	2021.08.02		MOT		모터 ON state 대기시간 0.5초->1초 원복
									(상승엔코더 정지에 의한 원점복귀후하강에서 전류초과로 정지 발생)
------------------------------------------------------------------------------									
V0.0.0.29	2021.07.26		SYS		부팅에서 지속성 이벤트 발생할 때 시작시간 구분 처리
									고온 발생과 해제의 통신 구분 처리(GT)
									고온감지 기준 70도->85도 상향 조정(GT)
									센싱주기 초과분 검사 조건 제거
									(최대센싱주기가8시긴까지만되어었었음.GT)
							
							ADC		온도 테이블 80도 -> 90도 까지 조정
									검출조건에 따른 온도 계산식 분기 처리 
------------------------------------------------------------------------------
V0.0.0.28	2021.07.20		SYS		지속성 이벤트 로그의 시작 시간은 최종점검 시간과 동일 처리
									(상기와 같이 PB에 사전 정의 되었고, 서버/단말  구현 오류 중  
									 서버측에서 선 인지/반영, 단말 반영 처리)
									손 걸림 지속성 이벤트 로그 저장이 누락분 반영함(CCB2)
									고온감지 지속성 확인 1분->10분 주기로 처리(GT)  
------------------------------------------------------------------------------
V0.0.0.27	2021.07.14		QRS		시스템 시간 설정 전에 저장된 QR 로그 시간 재 계산 조건 누락 반영

							MOT		수동 압축 완료일 때 적재량 측정되는 문제 처리
									(1.수동하강->엔코더정지->타임아웃->수동상승->원점복귀->적재량 센싱)
									(2.수동하강->엔코더정지->수동상승->원점복귀->적재량 센싱)
									손감지 안정화 시간 500ms->100ms 단축
									모터 ON state 대기 시간 1초->500ms 단축
									원격압축
									화재압축 대기 5분->10분 (기본 10분이였음) 
									상승 엔코더 초과로 압축 완료일 때 다음 압축 하지 않는 문제 수정
									(압축 로그에서  엔코더 값이 하강>상승 문제도 상기 원인이였음)
									화재 압축 1회 완료 후 동작 되지 않는 문제 처리 
									(V0.0.0.26 버전에서만 발생하는 문제였음)
									화재 압축 중 손감지/문열림 발생하고 해제 후에도 압축 재개 안되는 문제 처리  
									화재 압축 중 연기 감지 해제되면 모터 복귀하는 기능 제거 
									(화재 압축은 무조건 10분 동안 대기하도록 처리)

							FLS		정기센싱 주기 10분->30분 변경
							
							COM		모뎀 status 변경부분 seDrvParam함수에 누락 부분 반영
									(화재압축 두 번 압축 되지 않는 문제 원인임)
------------------------------------------------------------------------------
V0.0.0.26	2021.06.29		SYS		EEPROM에 정기보고주기/인디케이터레벨 저장
									iccid 데이터 전송 후 PB 메모리 해제 누락 처리
									시스템 시간 얻어 오지 못했을 경우, 로그 저장 시간 계산 개선
									정기센싱 주기 변수 16비트형 32비트형으로 변경
									(24시간 초로 변환시 오플로우 발생 방지)
									정기센싱 주기 EEPROM에 저장 후 재부팅에서 호출
									부팅 실패 했을 경우도 부팅 플래그 완료 표시 
									웨이크업 타이머와 알람 타이머 실행 했을 경우 다시 설정되도록 변경

							FLS		압축 센싱 주기 1분 -> 5분 변경
							
							LED		I2C 읽기/쓰기 실패일 때 포트 초기화 부분 추가
									적재량 인디케이터 설정값 EEPROM에 저장
							
							GPS		채널 유효성 검사 부분에서 변수 누락된 부분 처리 
							
							COM		다음 통신시 모뎀 채널 버퍼 데이터 남아 있는 부분 초기화 
									유심 읽기 실패일 때 모뎀 종료 시퀀스 수행되도록 변경
									데이터 전송 타임아웃 90초->30초 변경
									시스템 시간 획득 실패시 모뎀 설정 재시도
									QLTS를 통한 네트워크 동기화 시간 요청 추가
------------------------------------------------------------------------------
V0.0.0.25	2021.06.11		COM		EG25 통용 모뎀 전원 키 처리 
									EG25 모뎀 리셋 명령어 부재에 따른 HW 리셋 처리
									리셋 타임아웃 15초->20초 일괄 변경
									CSQ 1자리일 때 무한으로 CSQ 호출되는 문제 처리
									CSQ 99일 때 90초 재시도 처리
									REG 3초 간격으로 3분 동안 관찰하도록 처리
									Deprecated StatusFlags와 ReportType 제거

							SYS		적재량 초과 모드 통신시 지속성 이벤트 로그로 처리(GT)
									통신할 때 전압/온도 로그 보내도록 처리
									
							MOT		상승 엔코더 초과 조건문 오류 처리
------------------------------------------------------------------------------
V0.0.0.24	2021.06.03		LED		모델  빈프로파일(센서:113cm 내통:90cm) 수정(GT)
 									모델 최대 적재 모드 표시(GT)
 									장시간 문열림 통신시 톱니바퀴 표시등 노란색 켜지는 문제 수정
 							
 							QRS	 	최대 적재 모드일 경우 QR 인식 후 호퍼 잠금(GT)
 							
 							SYS		GT 모델 투입구 막힘 /화재알림/장시간 전면문 열림 통신을 위한 
 									Status Flag 프로토콜 추가(GT)
 									외부 온도로 화재 감지하는 부분 내부 온도로 변경(GT)
 									수거 요청 통신을 위한 REPORT TYPE 프로토콜 추가(GT)

							DOR		장시간 전면문 열림 로그 해제 누락 반영 									  
------------------------------------------------------------------------------
V0.0.0.23	2021.06.01		QRS		QR로그 전송 후 구조체 초기화(이전 로그값으로 데이터 꼬이는 문제 수정)
									무효한 QR일 경우 거리값 999으로 회수 필요 알람 발생 무시처리
									호퍼 개폐일 때 적재량 측정을 개 또는 폐일 때 측정으로 변경
							
							FLS		전원 후 대기 시간 2초->1초로 변경									
------------------------------------------------------------------------------
V0.0.0.22	2021.05.28		LED		GT 모델 indicator 기본 설정값 오류 수정 
						
							COM		펌웨어 모델별 구분 처리 삭제(ccb2-v5-fw.bin)
------------------------------------------------------------------------------
V0.0.0.21	2021.05.24		MOT		문 열린 상태에서 수동 조작은 지속, 동작 중 문 열림은 모터 정지
------------------------------------------------------------------------------
V0.0.0.20 	2021.05.14		COM		모뎀 전원 있을 때 통신 요청오면 모뎀 전원처리 무시
						
							QRS		QR인식 실패일 때 타임아웃 4초->2초 변경
------------------------------------------------------------------------------
V0.0.0.19 	2021.05.14 		QRS		호퍼 열림 10초 변경
									READY 상태로 변경될 때 시간변수 초기화 처리
									
							SYS		슬립  전 적재량에 따른 LED 색깔 얻어와서 설정으로 변경
------------------------------------------------------------------------------
V0.0.0.18	2021.05.13		SYS		고온 감지 온도 70도
									고온 경고 통신 후 계속 고온일 경우 1분 후 재통신
									정기통신시간 수신 처리
							QRS		로그갯수 및 데이터 누락에 따른 조치
									문열림/적재량측정중/통신중/ 동작 무시 처리 
									투입구 열린 상태에서 전면문 열릴 경우 투입구 닫힘 처리
							DOR		문 여닫힘 센싱, 압축 센싱으로 무시되는 문제 수정
							
V0.0.0.17	2021.05.12		SYS		GT용 펌웨어(ccb2-v5-fw-gt.bin)
									feature_gt_qr 브랜치에서 바이너리 생성
							
							QRS		로그 누적 갯수 20개일 때 통신 수행
							
							COM		펌웨어명 ccb2-v5-fw.bin와 ccb2-v5-fw-gt.bin로 구분
------------------------------------------------------------------------------
V0.0.0.16 	2021.04.30 		FLS		UART 채널 RX 전원에 의한 노이즈로 슬립에서 깨는 문제 수정
							
							COM		QISEND_READY 명령어 예외 처리
									FOTA 타임아웃 5분에서 3분으로 축소
									QFOTA_CHK 명령어에서 무한대기 되는 문제 수정
									QISEND_C 명령어 타임아웃 300초에서 30초로 변경
							
							MOT		v0.0.0.15 버전에서 세미 풀에서 압축 하지 않는 문제 수정
							
							LED		문 닫힘 후 
									버튼 조작에도 압축 동작과 같은 점멸 처리
									PWM 밝기 절반으로 감소
							
							SYS		시스템 대기 1분 이상일 때 강제 슬립 진입
------------------------------------------------------------------------------
V0.0.0.15	2021.04.28		GPS 	채널 실패 및 타임아웃에 따른 debug 로그 출력 수정
							
							MOT		부팅시 원점 복귀시 문 열림에서 모터 정지하지 못하는 문제 수정
									구동  전류 평균값 처리 변경
									압축 전류 측정값 대신 고정값으로 변경
									압축 모드 횟수 3->2회 설정로 변경 및 풀모드 비압축 처리
------------------------------------------------------------------------------
V0.0.0.14 	2021.04.21 		MOT		압축 최소 시간 해제 30분->0분 (시험용)

V0.0.0.13 	2021.04.19		MOT		모터 구동 후 전류 초과 감지 시간 3초->1초

V0.0.0.12 	2021.04.16 		SYS 	모터 ADC 2048값 이상 무효처리
							
							BTN 	센싱 중 버튼 입력시 센싱 무시처리
							
V0.0.0.11 	2021.04.13 		GPS		날짜,시간 동시 획득시 유효 조건 만족으로 처리
							SYS		모터 ADC 0,4095값 무효처리 및 유효갯수로 평균처리
							
V0.0.0.10	2021.04.08		SYS		시스템로그 저장 갯수 36->72개로 확장
									원격 리셋 요청과 OTA 리셋 통합
							COM		REG 정상 조건외 검출되지 않는 문제 수정
									데이터 전송 후 AT 실패시 모뎀 종료 처리
							
V0.0.0.9 	2021.04.07 		FLS 	전원 공급 후 2초 , 리셋 후 2초 대기 시간 추가
									로그 저장 버퍼 72개로 확장
							MOT 	상승 중 전류로 정지시 상승엔코더 누락 수정
									로그 저장 버퍼 36개로 축소
									
V0.0.0.8 	2021.04.06 		SYS 	시스템 FAULT 리셋, debug 로그에 해당 비트 표시
							COM 	CSQ 표시
							
V0.0.0.7 	2021.04.05 		SYS 	연기감지 압축
									지속성 이벤트 메모리 할당 실패 수정 및 전송 후 초기화 처리
									EXTI 채터링 필터 5ms 적용
							COM		서버 응답값 수신 완료 처리 수정

V0.0.0.6 	2021.03.29 		SYS 	정기센싱 24H 설정시 요일 변환되지 않는 문제 수정
									정기센싱 6H, 12H, 24H 시간 변환 오버플로우 수정
									펌웨어명 ccb2-v5-fw.bin로 변경
							FLS		전원 공급 후 1초 대기 시간 확보
							MTR 	전원 공급 후 센서 대기 시간에 따른 LED 점등 영향 개선
V0.0.0.5 	2021.03.26 		SYS 	BL,FW OTA를 위한 분리
									딥 스위치로 용량 판단 후 적재량 LED 표시처리
							FLS 	샘플링 갯수 10개 확장
									999일 경우 재시도 루틴 추가(3회면 센서에러)
									적재량 100%으로 계싼못하는 소수점 문제 수정
								 	측정 높이 3배수 제한 해제
								 	샘플링 필터 통하지 않는 문제 수정	
							DOR 	지속성 이벤트일 경우 통신 후 슬립 진입
							COM		응답값에 00으로 끝나면 파싱 못하는 문제 수정

V0.0.0.4 	2021.03.19 		SYS 	외부 온도 센서 검출되지 않으면 0으로 처리
							FLS 	적재량 100% 이상 계산식 변경
									ToF 센서 3초 수신없을 때 debug flag에 기록 
									bin profile 기본값 120L->100L로 변경 
						
V0.0.0.3 	2021.03.12 		SYS 	정기센싱 주기마다 온도 및 배터리 기록
									배터리 테이블 갱신 
									ADC 샘플링 1초마다 수행 처리
							MTR 	모터 원점 탈출 대기 1초  
									암축,이동 전류 측정 대기 3초